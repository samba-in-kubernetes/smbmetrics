name: CI
# Run tests on pull requests and after "merges"
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  # Allow manually triggering a run in the github ui.
  # See: https://docs.github.com/en/actions/using-workflows/manually-running-a-workflow
  workflow_dispatch: {}
jobs:
  # Do a build/compile smoke test
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/setup-go@44694675825211faa026b3c33043df3e48a5fa00
        with:
          go-version: "stable"
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
      - name: Build
        run: make
  # Run static/code-quality checks
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/setup-go@44694675825211faa026b3c33043df3e48a5fa00
        with:
          go-version: "stable"
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
      - name: Install build tools
        run: make build-tools
      - name: Run checks
        run: make check
  check-commits:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}
      - name: Ensure branches
        run: git fetch
      - name: Lint git commit messages
        run: make check-gitlint
  show-versions:
    needs: [build, check]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/setup-go@44694675825211faa026b3c33043df3e48a5fa00
        with:
          go-version: "stable"
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
      - name: Build
        run: make
      - name: Show info
        run: ./bin/smbmetrics --show-versions
  test:
    needs: [show-versions]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/setup-go@44694675825211faa026b3c33043df3e48a5fa00
        with:
          go-version: "stable"
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
      - name: Run tests
        run: make test
  podmanbuild:
    runs-on: ubuntu-latest
    # don't run on push, since the "push" job contains the
    # image build step, so no need to do it twice.
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
      - name: Install fuse-overlayfs
        run: sudo apt-get -y install fuse-overlayfs
      - name: Setup podman config
        run: |
          mkdir -p /home/runner/.config/containers/
          cat >/home/runner/.config/containers/storage.conf <<EOF
          [storage]
          driver = "overlay"
          graphroot = "${HOME}/.local/share/containers/storage2"

            [storage.options]
              mount_program = "/usr/bin/fuse-overlayfs"
          EOF
          cat >/home/runner/.config/containers/containers.conf <<EOF
          [containers]
          netns = "host"
          EOF
      - name: Build container image
        # note: forcing use of podman here since we are
        # using podman explicitly for the push job
        run: make CONTAINER_CMD=podman image-build
  dockerbuild:
    runs-on: ubuntu-latest
    # don't run on push, since the "push" job contains the
    # image build step, so no need to do it twice.
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
      - name: Build container image
        # note: forcing use of podman here since we are
        # using podman explicitly for the push job
        run: make CONTAINER_CMD=docker image-build
